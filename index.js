const TelegramBot = require("node-telegram-bot-api");
const schedule = require("node-schedule");

// –¢–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞
require("dotenv").config();
const token = process.env.TELEGRAM_BOT_TOKEN;
const bot = new TelegramBot(token, { polling: true });
require("dotenv").config();
const mongoose = require("mongoose");

mongoose
  .connect(process.env.MONGO_URI, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  })
  .then(() => console.log("‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ MongoDB"))
  .catch((err) => console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:", err));

// –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: –∑–±–µ—Ä—ñ–≥–∞—î —Å—Ç–∞–Ω –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
let usersState = {}; // –§–æ—Ä–º–∞—Ç: { chatId: { day: number, step: number, startDate: Date, lastActive: Date } }

// –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–µ–æ —Ç–∞ —Ñ–∞–π–ª–∏
const courseContent = [
  {
    day: 1,
    steps: [
      {
        image: "./covers/day_1.jpg",
        text: "–°—å–æ–≥–æ–¥–Ω—ñ –º–∏ –∑ –≤–∞–º–∏ –∑–Ω–∞–π–æ–º–∏–º–æ—Å—è. üòá –ü–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º, —â–æ–± –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—ñ–¥–µ–æ, —É —è–∫–æ–º—É —è —Ä–æ–∑–ø–æ–≤—ñ–º –ø—Ä–æ —Å–µ–±–µ —Ç–∞ –ø—Ä–æ –∫—É—Ä—Å.",
        video: "https://youtu.be/JVX3zmS5tmk",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–¢–µ–ø–µ—Ä, –ø—ñ—Å–ª—è –Ω–∞—à–æ–≥–æ –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞, —è —Ö–æ—á—É –±—ñ–ª—å—à –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–æ–∑–ø–æ–≤—ñ—Å—Ç–∏ –≤–∞–º –ø—Ä–æ –ø–∞–Ω—ñ—á–Ω—ñ –∞—Ç–∞–∫–∏. –ü–µ—Ä–µ—Ö–æ–¥—å—Ç–µ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º. üß†‚ú®",
        video: "https://youtu.be/6g5zq2mW4Ks",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–ê —Ç–µ–ø–µ—Ä –ø—Ä–æ—à—É –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—É —Ñ–æ—Ä–º—É. üìù –¶–µ –¥–æ–ø–æ–º–æ–∂–µ –º–µ–Ω—ñ –æ—Ü—ñ–Ω–∏—Ç–∏ –≤–∞—à —Å—Ç–∞–Ω —ñ –ø–æ—Ç—Ä–µ–±–∏. –î—è–∫—É—é! üíï",
        image: "./covers/google_form.jpg",
        form: "https://docs.google.com/forms/d/e/1FAIpQLSci3Qdk-sIb6Gbgthd4KpeEhxnRtb3oG7yslV5XTHgW41UcVw/viewform?usp=sf_link",
      },
      {
        text: "–¶–µ –≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ! –ü—Ä–æ–¥–æ–≤–∂–∏–º–æ –∑–∞–≤—Ç—Ä–∞ –æ 18:00 –∑–∞ –ö–∏—ó–≤—Å—å–∫–∏–º —á–∞—Å–æ–º. üòä –î–æ –∑—É—Å—Ç—Ä—ñ—á—ñ!",
      },
    ],
  },
  {
    day: 2,
    steps: [
      {
        image: "./covers/day_2.jpg",
        text: "–í—ñ—Ç–∞—é! –°—å–æ–≥–æ–¥–Ω—ñ –º–∏ —Ä–æ–∑–ø–æ—á–∏–Ω–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω—É —Ä–æ–±–æ—Ç—É. üöÄ –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –≤—ñ–¥–µ–æ, —â–æ–± –∫—Ä–∞—â–µ –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —è–∫ –≤–∞—à–µ —Ç—ñ–ª–æ, –µ–º–æ—Ü—ñ—ó —Ç–∞ –¥—É–º–∫–∏ —Ä–µ–∞–≥—É—é—Ç—å –Ω–∞ —Å—Ç—Ä–µ—Å. üß†",
        video: "https://youtu.be/ibpoVB_YsB4",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–¢–µ–ø–µ—Ä –ø—Ä–æ–ø–æ–Ω—É—é –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –ø—Ä–∞–∫—Ç–∏–∫–∏! üßò‚Äç‚ôÄÔ∏è –£ —Ü—å–æ–º—É –≤—ñ–¥–µ–æ –º–∏ —Ä–æ–∑–≥–ª—è–Ω–µ–º–æ –≤–∞–∂–ª–∏–≤—ñ—Å—Ç—å –≤–ø—Ä–∞–≤ –Ω–∞ –¥–∏—Ö–∞–Ω–Ω—è —Ç–∞ –ø–æ–ø—Ä–∞–∫—Ç–∏–∫—É—î–º–æ —Ç–µ—Ö–Ω—ñ–∫—É '–¥—ñ–∞—Ñ—Ä–∞–≥–º–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ö–∞–Ω–Ω—è'.",
        video: "https://youtu.be/2yatrw0CzgE",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–¶–µ –≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ! –ü—Ä–æ–¥–æ–≤–∂–∏–º–æ –∑–∞–≤—Ç—Ä–∞ –æ 18:00 –∑–∞ –ö–∏—ó–≤—Å—å–∫–∏–º —á–∞—Å–æ–º. üòä –î–æ –∑—É—Å—Ç—Ä—ñ—á—ñ!",
      },
    ],
  },
  {
    day: 3,
    steps: [
      {
        image: "./covers/day_3.jpg",
        text: "–ü—Ä–∏–≤—ñ—Ç! üåä –°—å–æ–≥–æ–¥–Ω—ñ –º–∏ —Ä–æ–∑–≥–ª—è–Ω–µ–º–æ –ø–æ–Ω—è—Ç—Ç—è '–•–≤–∏–ª—è —Å—Ç—Ä–µ—Å—É'. –¶–µ –¥–æ–ø–æ–º–æ–∂–µ –∫—Ä–∞—â–µ –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —è–∫ —Å—Ç—Ä–µ—Å –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Ç—ñ–ª–æ —ñ –ø—Å–∏—Ö—ñ–∫—É. üß†üí°",
        video: "https://youtu.be/2IXCtmOFxI0",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –ø—Ä–∞–∫—Ç–∏–∫–∏! üßò‚Äç‚ôÇÔ∏è –°—å–æ–≥–æ–¥–Ω—ñ –º–∏ –Ω–∞–≤—á–∏–º–æ—Å—è –≤–ø—Ä–∞–≤–∞–º –∑–∞–∑–µ–º–ª–µ–Ω–Ω—è, —è–∫—ñ –¥–æ–ø–æ–º–∞–≥–∞—é—Ç—å –∑–Ω–∏–∑–∏—Ç–∏ —Å–∏–º–ø—Ç–æ–º–∏ –ø–∞–Ω—ñ—á–Ω–∏—Ö –∞—Ç–∞–∫. –ü–µ—Ä–µ—Ö–æ–¥—å—Ç–µ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º!",
        video: "https://youtu.be/Qrm21OWm1Gk",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–¶–µ –≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ! –ü—Ä–æ–¥–æ–≤–∂–∏–º–æ –∑–∞–≤—Ç—Ä–∞ –æ 18:00 –∑–∞ –ö–∏—ó–≤—Å—å–∫–∏–º —á–∞—Å–æ–º. üòä –î–æ –∑—É—Å—Ç—Ä—ñ—á—ñ!",
      },
    ],
  },
  {
    day: 4,
    steps: [
      {
        image: "./covers/day_4.jpg",
      },
      {
        text: "–í—ñ—Ç–∞—é! üß† –°—å–æ–≥–æ–¥–Ω—ñ –º–∏ –ø–æ–≥–æ–≤–æ—Ä–∏–º–æ –ø—Ä–æ —Ç–µ, —è–∫ —Ç—Ä–∏–≥–µ—Ä–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—å –ø–∞–Ω—ñ—á–Ω—É –∞—Ç–∞–∫—É —Ç–∞ —á–æ–º—É –≤–∏–Ω–∏–∫–∞—î –ø–∞–Ω—ñ—á–Ω–∏–π —Ä–æ–∑–ª–∞–¥.",
        video: "https://youtu.be/_lSblgI7PTI",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–¢–µ–ø–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –ø—Ä–∞–∫—Ç–∏–∫–∏! üìù –í–∏–∫–æ–Ω–∞–π—Ç–µ –≤–ø—Ä–∞–≤—É, —è–∫–∞ –¥–æ–ø–æ–º–æ–∂–µ –≤–∞–º –∑–Ω–∞–π—Ç–∏ –≤–ª–∞—Å–Ω—ñ —Ç—Ä–∏–≥–µ—Ä–∏ —Ç–∞ –Ω–∞–≤—á–∏—Ç–∏—Å—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞—Ç–∏ —ó—Ö –Ω–∞ —Ä–∞–Ω–Ω—ñ—Ö –µ—Ç–∞–ø–∞—Ö.",
        video: "https://youtu.be/cac0iNstWs4",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–¶–µ –≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ! –ü—Ä–æ–¥–æ–≤–∂–∏–º–æ –∑–∞–≤—Ç—Ä–∞ –æ 18:00 –∑–∞ –ö–∏—ó–≤—Å—å–∫–∏–º —á–∞—Å–æ–º. üòä –î–æ –∑—É—Å—Ç—Ä—ñ—á—ñ!",
      },
    ],
  },
  {
    day: 5,
    steps: [
      {
        image: "./covers/day_5.jpg",
        text: "–ü—Ä–∏–≤—ñ—Ç! üßò‚Äç‚ôÄÔ∏è –°—å–æ–≥–æ–¥–Ω—ñ –º–∏ –ø–æ–≥–æ–≤–æ—Ä–∏–º–æ –ø—Ä–æ —ñ–Ω—à—ñ —Ñ–∞–∫—Ç–æ—Ä–∏, —è–∫—ñ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ –≤–∏–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–∞–Ω—ñ—á–Ω–∏—Ö –∞—Ç–∞–∫: —Å—Ç–æ—Å—É–Ω–∫–∏ —Ç–∞ —Å–ø–æ—Å—ñ–± –∂–∏—Ç—Ç—è. ü§ù",
        video: "https://youtu.be/MI_tZpO9ijw",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ! üåü –í–∏–∫–æ–Ω–∞–π—Ç–µ –≤–ø—Ä–∞–≤—É '–¢—Ä–∏ –∫–æ–ª–∞ –≤–∑–∞—î–º–æ–¥—ñ—ó', —è–∫–∞ –¥–æ–ø–æ–º–æ–∂–µ –∫—Ä–∞—â–µ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ –≤–∞—à—ñ —Å—Ç–æ—Å—É–Ω–∫–∏ —Ç–∞ —ó—Ö–Ω—ñ–π –≤–ø–ª–∏–≤ –Ω–∞ –≤–∞—Å.",
        video: "https://youtu.be/8cnw4hhrJcM",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–Ω—è ‚Äî —Ç–µ—Ö–Ω—ñ–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–Ω—è, —è–∫–∞ –¥–æ–ø–æ–º–æ–∂–µ —Å—Ç–∞–±—ñ–ª—ñ–∑—É–≤–∞—Ç–∏ –Ω–µ—Ä–≤–æ–≤—É —Å–∏—Å—Ç–µ–º—É. üßò‚Äç‚ôÄÔ∏è",
        video: "https://youtu.be/yl9-wwrwHGU",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–¶–µ –≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ! –ü—Ä–æ–¥–æ–≤–∂–∏–º–æ –∑–∞–≤—Ç—Ä–∞ –æ 18:00 –∑–∞ –ö–∏—ó–≤—Å—å–∫–∏–º —á–∞—Å–æ–º. üòä –î–æ –∑—É—Å—Ç—Ä—ñ—á—ñ!",
      },
    ],
  },
  {
    day: 6,
    steps: [
      {
        image: "./covers/day_6.jpg",
        text: "–ü—Ä–∏–≤—ñ—Ç! –°—å–æ–≥–æ–¥–Ω—ñ —è —Ö–æ—á—É –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è —Å–≤–æ—î—é —ñ—Å—Ç–æ—Ä—ñ—î—é ‚Äî –≤–ª–∞—Å–Ω–∏–º –¥–æ—Å–≤—ñ–¥–æ–º –ø–æ–¥–æ–ª–∞–Ω–Ω—è –ø–∞–Ω—ñ—á–Ω–∏—Ö –∞—Ç–∞–∫. üåü",
        video: "https://youtu.be/hMeFFsQQ4Lg",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –ø—Ä–∞–∫—Ç–∏–∫–∏ –º–µ–¥–∏—Ç–∞—Ü—ñ—ó. üßò‚Äç‚ôÄÔ∏è –ü—Ä–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ –≤–æ–Ω–∞ –¥–æ–ø–æ–º–æ–∂–µ –∑–Ω–∏–∑–∏—Ç–∏ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å. –ü–æ—á–Ω–µ–º–æ –∑–∞—Ä–∞–∑!",
        video: "https://youtu.be/3Qar8yR5jt0",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–¶–µ –≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ! –ü—Ä–æ–¥–æ–≤–∂–∏–º–æ –∑–∞–≤—Ç—Ä–∞ –æ 18:00 –∑–∞ –ö–∏—ó–≤—Å—å–∫–∏–º —á–∞—Å–æ–º. üòä –î–æ –∑—É—Å—Ç—Ä—ñ—á—ñ!",
      },
    ],
  },
  {
    day: 7,
    steps: [
      {
        image: "./covers/day_7.jpg",
        text: "–í—ñ—Ç–∞—é! üéâ –í–∏ –¥—ñ–π—à–ª–∏ –¥–æ —Ñ—ñ–Ω–∞–ª—É –∫—É—Ä—Å—É '–®–ª—è—Ö –¥–æ —Å–ø–æ–∫–æ—é: —è–∫ —à–≤–∏–¥–∫–æ –ø–æ–∑–±—É—Ç–∏—Å—è –ø–∞–Ω—ñ—á–Ω–∏—Ö –∞—Ç–∞–∫'. –°—å–æ–≥–æ–¥–Ω—ñ –º–∏ –ø—ñ–¥—Å—É–º—É—î–º–æ –≤—Å—ñ –∑–Ω–∞–Ω–Ω—è —Ç–∞ —Ç–µ—Ö–Ω—ñ–∫–∏, —è–∫—ñ –≤–∏ –æ–ø–∞–Ω—É–≤–∞–ª–∏.",
        video: "https://youtu.be/sPv3oX8aQBU",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–æ–±—ñ –ß–µ–∫-–ª–∏—Å—Ç! –í—ñ–Ω –¥–æ–ø–æ–º–æ–∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É–≤–∞—Ç–∏ —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –Ω–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ –∑–Ω–∞–Ω–Ω—è, —è–∫—ñ –≤–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –ø—ñ–¥ —á–∞—Å –∫—É—Ä—Å—É. üìö",
        pdf: "./files/CheckList.pdf",
      },

      {
        text: "–î–ª—è —Ä–µ–ª–∞–∫—Å—É –ø—Ä–æ–≤–µ–¥–µ–º–æ –∞–≤—Ç–æ—Ä—Å—å–∫—É –º–µ–¥–∏—Ç–∞—Ü—ñ—é '–ó—ñ—Ä–∫–∞'. üßò‚Äç‚ôÄÔ∏è –í–æ–Ω–∞ –¥–æ–ø–æ–º–æ–∂–µ –≤–∞–º —Ä–æ–∑—Å–ª–∞–±–∏—Ç–∏—Å—è —Ç–∞ –≤—ñ–¥—á—É—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Å–ø–æ–∫—ñ–π.",
        video: "https://youtu.be/pk8_7tBcRuU",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },
      {
        text: "–ù–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è ‚Äî —Ç–µ—Ö–Ω—ñ–∫–∞ '–ü–æ–¥—è–∫–∞'. üíï –í–æ–Ω–∞ –¥–æ–ø–æ–º–æ–∂–µ –∫—Ä–∞—â–µ —Å–ø—Ä–∞–≤–ª—è—Ç–∏—Å—è –∑—ñ —Å—Ç—Ä–µ—Å–æ–º —ñ —Ç—Ä–∏–≤–æ–≥–æ—é.",
        video: "https://youtu.be/dsTbpMFcXko",
        button: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É üé•",
      },

      {
        text: "–ë–æ–Ω—É—Å! üé∂ –¢—Ä–∏ –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ñ —Ç—Ä–µ–∫–∏ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:",
        audio: [
          "./audio/meditation1.mp3",
          "./audio/meditation2.mp3",
          "./audio/meditation3.mp3",
        ],
      },
      {
        text: "–¶–µ —â–µ –Ω–µ –≤—Å–µ! –Ø –ø—ñ–¥–≥–æ—Ç—É–≤–∞–ª–∞ –ø–∞–º'—è—Ç–∫—É, —è–∫—É –í–∏ –∑–º–æ–∂–µ—Ç–µ —Ä–æ–∑–¥—Ä—É–∫—É–≤–∞—Ç–∏. –í–∏–∫–æ–Ω—É–π—Ç–µ —Ü—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —ñ –ø–∞–Ω—ñ—á–Ω–∞ –∞—Ç–∞–∫–∞ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞—Ö–æ–ø–∏—Ç—å –∑–Ω–µ–Ω–∞—Ü—å–∫–∞! üìö",
        pdf: "./files/practice_every_day.pdf",
      },
      {
        text: "–Ü —Ü–µ —â–µ –Ω–µ –≤—Å–µ! –¶–µ –ø–∞–º'—è—Ç–∫–∞, —è–∫ –ø–æ–≤–æ–¥–∏—Ç–∏—Å—è –ø—ñ–¥ —á–∞—Å –ø–∞–Ω—ñ—á–Ω–æ—ó –∞—Ç–∞–∫–∏! –ó–∞–ø–∞–º—è—Ç–∞–π—Ç–µ, —Ç—ñ–ª—å–∫–∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ñ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –¥–æ–ø–æ–º–æ–∂—É—Ç—å —à–≤–∏–¥–∫–æ –ø–æ–¥–æ–ª–∞—Ç–∏ –ø–∞–Ω—ñ—á–Ω—É –∞—Ç–∞–∫—É —Ç–∞ –ø–æ–∑–±—É—Ç–∏—Å—è —ó—Ö –Ω–∞–∑–∞–≤–∂–¥–∏! üìö",
        pdf: "./files/stop_panic_attack.pdf",
      },
      {
        text: "–î—è–∫—É—é, —â–æ –±—É–ª–∏ –∑—ñ –º–Ω–æ—é –Ω–∞ —Ü—å–æ–º—É —à–ª—è—Ö—É! ‚ù§ –ë–∞–∂–∞—é –≤–∞–º –≥–∞—Ä–º–æ–Ω—ñ—ó —Ç–∞ —Å–ø–æ–∫–æ—é.",
      },
    ],
  },
];

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏, —á–∏ –¥–æ—Å—Ç—É–ø –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è
const isAccessValid = (startDate) => {
  const currentDate = new Date();
  const expiryDate = new Date(startDate);
  expiryDate.setMonth(expiryDate.getMonth() + 6); // –î–æ–¥–∞—î–º–æ 6 –º—ñ—Å—è—Ü—ñ–≤ –¥–æ –¥–∞—Ç–∏ –ø–æ—á–∞—Ç–∫—É

  return currentDate <= expiryDate;
};

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫—Ä–æ–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
const sendStep = async (chatId) => {
  const userState = usersState[chatId];

  if (!userState) return;

  const { day, step, startDate } = userState;

  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–Ω–∏–π
  if (!isAccessValid(startDate)) {
    bot.sendMessage(
      chatId,
      "–í–∞—à –¥–æ—Å—Ç—É–ø –¥–æ –∫—É—Ä—Å—É –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è. –•–æ—á–µ—Ç–µ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏? üòä",
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –¥–æ—Å—Ç—É–ø", callback_data: "renew_access" }],
          ],
        },
      }
    );
    return;
  }

  const todayContent = courseContent.find((content) => content.day === day);

  if (!todayContent || !todayContent.steps[step]) {
    bot.sendMessage(
      chatId,
      "–¶–µ –≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ! –ü—Ä–æ–¥–æ–≤–∂–∏–º–æ –∑–∞–≤—Ç—Ä–∞. üòä"
    );
    return;
  }

  const currentStep = todayContent.steps[step];

  await bot.sendMessage(chatId, currentStep.text);

  if (currentStep.image) {
    await bot.sendPhoto(chatId, currentStep.image);
  }

  if (currentStep.video) {
    await bot.sendMessage(chatId, `–î–∏–≤–∏—Å—å –≤—ñ–¥–µ–æ —Ç—É—Ç: ${currentStep.video}`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: currentStep.button, url: currentStep.video }],
        ],
      },
    });
  }

  if (currentStep.audio) {
    if (Array.isArray(currentStep.audio)) {
      for (const audio of currentStep.audio) {
        await bot.sendAudio(chatId, audio);
      }
    } else {
      await bot.sendAudio(chatId, currentStep.audio);
    }
  }

  if (currentStep.pdf) {
    await bot.sendDocument(chatId, currentStep.pdf);
  }

  if (currentStep.form) {
    await bot.sendMessage(chatId, `–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É —Ç—É—Ç: ${currentStep.form}`);
  }

  if (todayContent.steps[step + 1]) {
    await bot.sendMessage(chatId, "–ö–æ–ª–∏ –±—É–¥–µ—à –≥–æ—Ç–æ–≤–∏–π, –Ω–∞—Ç–∏—Å–Ω–∏ '–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏'!", {
      reply_markup: {
        inline_keyboard: [[{ text: "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏", callback_data: "continue" }]],
      },
    });
  }
};

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
const checkUserActivity = () => {
  const currentDate = new Date();

  for (const chatId in usersState) {
    const userState = usersState[chatId];
    const { lastActive } = userState;

    if (
      lastActive &&
      (currentDate - new Date(lastActive)) / (1000 * 60 * 60 * 24) > 3
    ) {
      bot.sendMessage(
        chatId,
        "–ú–∏ –ø–æ–º—ñ—Ç–∏–ª–∏, —â–æ –≤–∏ –Ω–µ –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç–µ –∫—É—Ä—Å. üòä –ü–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤, —â–æ–± –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –Ω–∞–≤—á–∞–Ω–Ω—è!"
      );
    }
  }
};

// –†–æ–∑–∫–ª–∞–¥ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
schedule.scheduleJob("0 18 * * *", checkUserActivity); // –©–æ–¥–Ω—è –æ 18:00

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;

  if (usersState[chatId]) {
    bot.sendMessage(chatId, "–í–∏ –≤–∂–µ –ø–æ—á–∞–ª–∏ –∫—É—Ä—Å!");
    return;
  }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å—Ç–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  usersState[chatId] = {
    day: 1,
    step: 0,
    startDate: new Date(), // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞—Ç—É –ø–æ—á–∞—Ç–∫—É
    lastActive: new Date(),
  };

  bot.sendMessage(
    chatId,
    "–ü—Ä–∏–≤—ñ—Ç! –í—ñ—Ç–∞—é –≤–∞—Å –Ω–∞ –∫—É—Ä—Å—ñ '–®–ª—è—Ö –¥–æ —Å–ø–æ–∫–æ—é: —è–∫ —à–≤–∏–¥–∫–æ –ø–æ–∑–±—É—Ç–∏—Å—è –ø–∞–Ω—ñ—á–Ω–∏—Ö –∞—Ç–∞–∫'! üòä"
  );

  // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–µ—Ä—à–∏–π –∫—Ä–æ–∫
  sendStep(chatId);
});

// –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏"
bot.on("callback_query", (query) => {
  const chatId = query.message.chat.id;

  if (query.data === "continue") {
    const userState = usersState[chatId];

    // –Ø–∫—â–æ –¥–µ–Ω—å –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–π, –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –¥–µ–Ω—å
    const todayContent = courseContent.find(
      (content) => content.day === userState.day
    );
    if (todayContent && userState.step < todayContent.steps.length - 1) {
      usersState[chatId].step += 1;
    } else {
      // –Ø–∫—â–æ –¥–µ–Ω—å –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ
      usersState[chatId].day += 1;
      usersState[chatId].step = 0;
    }

    usersState[chatId].lastActive = new Date();
    sendStep(chatId);
  }

  if (query.data === "renew_access") {
    // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞—Ç—É –ø–æ—á–∞—Ç–∫—É –¥–æ—Å—Ç—É–ø—É
    usersState[chatId].startDate = new Date();
    bot.sendMessage(
      chatId,
      "–í–∞—à –¥–æ—Å—Ç—É–ø —É—Å–ø—ñ—à–Ω–æ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–æ —â–µ –Ω–∞ 6 –º—ñ—Å—è—Ü—ñ–≤! üöÄ"
    );
    sendStep(chatId);
  }
});
